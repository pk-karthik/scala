package scala.collection.immutable

import org.junit.Assert._
import org.junit.Test

class RedBlackTreeSerialFormat {

  def write(o: AnyRef): Array[Byte] = {
    val ba = new java.io.ByteArrayOutputStream(512)
    val out = new java.io.ObjectOutputStream(ba)
    out.writeObject(o)
    out.close()
    ba.toByteArray()
  }

  def read(buffer: Array[Byte]): AnyRef = {
    val in =
      new java.io.ObjectInputStream(new java.io.ByteArrayInputStream(buffer))
    in.readObject()
  }

  def parse(str: String) : Array[Byte] = {
    val b = Array.newBuilder[Byte]
    var i = 0
    while (i < str.length) {
      b += java.lang.Integer.parseInt(str.substring(i, i+2), 16).toByte
      i += 2
    }
    b.result()
  }

  def testParse(tree:AnyRef, shouldRoundTrip: Boolean, bin: String): Unit = {
    if (shouldRoundTrip) {
      val bytes = write(tree)
      val asString = s"${bytes.map(b => f"$b%02X").mkString}"
      assertEquals(bin, asString)
    }
    val recovered = read(parse(bin))
    assertEquals(tree, recovered)
  }


  val data = List.tabulate(10)(i => s"key$i" -> s"value:$i")
  val treeMap: TreeMap[String, String] = (TreeMap.newBuilder[String, String] ++= data).result()
  val treeSet: TreeSet[String] = (TreeSet.newBuilder[String] ++= data.map(_._1)).result()

  @Test def parseTreeMapBeforeMutableRedBlackTree {
    testParse(treeMap, false, "ACED0005737200227363616C612E636F6C6C656374696F6E2E696D6D757461626C652E547265654D6170416E108B62F3AFC20200024C00086F72646572696E677400154C7363616C612F6D6174682F4F72646572696E673B4C00047472656574002E4C7363616C612F636F6C6C656374696F6E2F696D6D757461626C652F526564426C61636B5472656524547265653B78707372001B7363616C612E6D6174682E4F72646572696E6724537472696E6724DD981A719E75481A0200007870737200317363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524426C61636B54726565CD1C6708A7A754010200007872002C7363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524547265656BA824B21C96EC32020005490005636F756E744C00036B65797400124C6A6176612F6C616E672F4F626A6563743B4C00046C65667471007E00024C0005726967687471007E00024C000576616C756571007E000878700000000A7400046B6579337371007E0006000000037400046B6579317371007E0006000000017400046B657930707074000776616C75653A307371007E0006000000017400046B657932707074000776616C75653A3274000776616C75653A317371007E0006000000067400046B6579357371007E0006000000017400046B657934707074000776616C75653A347372002F7363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524526564547265655A6F5AFFBDC0180C0200007871007E0007000000047400046B6579377371007E0006000000017400046B657936707074000776616C75653A367371007E0006000000027400046B657938707371007E0019000000017400046B657939707074000776616C75653A3974000776616C75653A3874000776616C75653A3774000776616C75653A3574000776616C75653A33")
  }
  @Test def parseTreeSetBeforeMutableRedBlackTree {
    testParse(treeSet, false, "ACED0005737200227363616C612E636F6C6C656374696F6E2E696D6D757461626C652E54726565536574B117552038DB580B0200024C00086F72646572696E677400154C7363616C612F6D6174682F4F72646572696E673B4C00047472656574002E4C7363616C612F636F6C6C656374696F6E2F696D6D757461626C652F526564426C61636B5472656524547265653B78707372001B7363616C612E6D6174682E4F72646572696E6724537472696E6724DD981A719E75481A0200007870737200317363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524426C61636B54726565CD1C6708A7A754010200007872002C7363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524547265656BA824B21C96EC32020005490005636F756E744C00036B65797400124C6A6176612F6C616E672F4F626A6563743B4C00046C65667471007E00024C0005726967687471007E00024C000576616C756571007E000878700000000A7400046B6579337371007E0006000000037400046B6579317371007E0006000000017400046B6579307070737200177363616C612E72756E74696D652E426F786564556E697474A67D471DECCB9A02000078707371007E0006000000017400046B657932707071007E001071007E00107371007E0006000000067400046B6579357371007E0006000000017400046B657934707071007E00107372002F7363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524526564547265655A6F5AFFBDC0180C0200007871007E0007000000047400046B6579377371007E0006000000017400046B657936707071007E00107371007E0006000000027400046B657938707371007E0017000000017400046B657939707071007E001071007E001071007E001071007E001071007E0010")
  }

  @Test def parseTreeMapAfterMutableRedBlackTree {
    testParse(treeMap, true, "ACED0005737200227363616C612E636F6C6C656374696F6E2E696D6D757461626C652E547265654D6170416E108B62F3AFC20300024C00086F72646572696E677400154C7363616C612F6D6174682F4F72646572696E673B4C0004747265657400314C7363616C612F636F6C6C656374696F6E2F696D6D757461626C652F4E6577526564426C61636B5472656524547265653B78707372001B7363616C612E6D6174682E4F72646572696E6724537472696E6724DD981A719E75481A0200007870737200317363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524426C61636B54726565CD1C6708A7A754010200007872002C7363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524547265656BA824B21C96EC32020005490005636F756E744C00036B65797400124C6A6176612F6C616E672F4F626A6563743B4C00046C65667471007E00084C0005726967687471007E00084C000576616C756571007E000878700000000A7400046B6579337371007E0006000000037400046B6579317371007E0006000000017400046B657930707074000776616C75653A307371007E0006000000017400046B657932707074000776616C75653A3274000776616C75653A317371007E0006000000067400046B6579357371007E0006000000017400046B657934707074000776616C75653A347372002F7363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524526564547265655A6F5AFFBDC0180C0200007871007E0007000000047400046B6579377371007E0006000000017400046B657936707074000776616C75653A367371007E0006000000027400046B657938707371007E0019000000017400046B657939707074000776616C75653A3974000776616C75653A3874000776616C75653A3774000776616C75653A3574000776616C75653A3378")
  }
  @Test def parseTreeSetAfterMutableRedBlackTree {
    testParse(treeSet, true, "ACED0005737200227363616C612E636F6C6C656374696F6E2E696D6D757461626C652E54726565536574B117552038DB580B0300024C00086F72646572696E677400154C7363616C612F6D6174682F4F72646572696E673B4C0004747265657400314C7363616C612F636F6C6C656374696F6E2F696D6D757461626C652F4E6577526564426C61636B5472656524547265653B78707372001B7363616C612E6D6174682E4F72646572696E6724537472696E6724DD981A719E75481A0200007870737200317363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524426C61636B54726565CD1C6708A7A754010200007872002C7363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524547265656BA824B21C96EC32020005490005636F756E744C00036B65797400124C6A6176612F6C616E672F4F626A6563743B4C00046C65667471007E00084C0005726967687471007E00084C000576616C756571007E000878700000000A7400046B6579337371007E0006000000037400046B6579317371007E0006000000017400046B6579307070737200177363616C612E72756E74696D652E426F786564556E697474A67D471DECCB9A02000078707371007E0006000000017400046B657932707071007E001071007E00107371007E0006000000067400046B6579357371007E0006000000017400046B657934707071007E00107372002F7363616C612E636F6C6C656374696F6E2E696D6D757461626C652E526564426C61636B5472656524526564547265655A6F5AFFBDC0180C0200007871007E0007000000047400046B6579377371007E0006000000017400046B657936707071007E00107371007E0006000000027400046B657938707371007E0017000000017400046B657939707071007E001071007E001071007E001071007E001071007E001078")
  }
}